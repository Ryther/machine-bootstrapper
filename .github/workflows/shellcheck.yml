name: ShellCheck

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  shellcheck-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Discover shell scripts
        id: find-scripts
        run: |
          # Find all .sh files
          SHELL_FILES=$(find . -type f -name "*.sh" ! -path "./.git/*" ! -path "./node_modules/*")

          # Find files with shell shebangs (sh, bash, zsh, fish)
          SHEBANG_FILES=$(find . -type f ! -name "*.sh" ! -path "./.git/*" ! -path "./node_modules/*" -exec sh -c '
            head -n 1 "$1" | grep -qE "^#!/(usr/bin/env |bin/)(sh|bash|zsh|fish)"
          ' sh {} \; -print)

          # Combine and deduplicate
          ALL_SCRIPTS=$(echo "$SHELL_FILES $SHEBANG_FILES" | tr ' ' '\n' | sort -u | tr '\n' ' ')

          if [ -z "$ALL_SCRIPTS" ]; then
            echo "No shell scripts found"
            echo "scripts=" >> $GITHUB_OUTPUT
          else
            echo "Found shell scripts:"
            echo "$ALL_SCRIPTS" | tr ' ' '\n'
            echo "scripts=$ALL_SCRIPTS" >> $GITHUB_OUTPUT
          fi

      - name: Run ShellCheck (informative with style issues)
        if: steps.find-scripts.outputs.scripts != ''
        continue-on-error: true
        run: |
          echo "::group::ShellCheck - Severity >= Style Issues (informative)"
          shellcheck -s sh -S style ${{ steps.find-scripts.outputs.scripts }} || echo "⚠️ Potential issues found (non-blocking)"
          echo "::endgroup::"

      - name: Run ShellCheck (enforcement - warnings and errors only)
        if: steps.find-scripts.outputs.scripts != ''
        run: |
          echo "::group::ShellCheck - Blocking Issues (warning and error)"
          shellcheck -s sh -S warning ${{ steps.find-scripts.outputs.scripts }}
          echo "::endgroup::"
